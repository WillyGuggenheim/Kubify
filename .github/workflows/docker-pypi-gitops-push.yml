name: docker-pypi-gitops-push
on:
  push:
    branches:
      - 'main' # release branch of approved pr that is merged and tagged (with :main tag)
      - 'kubify-9001' # testing docker release cicd in this branch (origin/kubify-9001)
jobs:
  version:
    name: Bump package version
    if: "!contains(github.event.head_commit.message, 'Bump version')"
    runs-on: ubuntu-20.04
    steps:
    - name: actions/checkout
      uses: actions/checkout@v2
      with:
          persist-credentials: false
    - name: current_version
      run: echo "current_version=$(grep '# version' version.md | cut -d ' ' -f3)" >> $GITHUB_ENV
    - name: FragileTech/bump-version
      uses: FragileTech/bump-version@main
      with:
        current_version: "${{ env.current_version }}"
        files: version.md
        commit_name: Kubify-Actions
        commit_email: w@kubify.com
        token: "${{ secrets.GITHUB_TOKEN }}"
  docker:
    name: Release Docker Image
    runs-on: nvcr.io/nvidia/cuda:11.7.0-runtime-ubuntu22.04 # or ubuntu-latest
    steps:
      - name: get-version
        id: getversion
        run: echo "::set-output name=version::$(cat __version__)"
      - name: pypi-make-package
        id: getversion
        run: apt update && apt install -y make && make package
      # pypi package ship
      - name: release-pypi
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
      # docker build multi-arch setup
      -
        name: setup-qemu-multiarch
        uses: docker/setup-qemu-action@v2
      -
        name: setup-biuldx-multiarch
        uses: docker/setup-buildx-action@v2
      -
        name: login-dockerhub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      # dockerhub image build security package ship
      -
        name: release-dockerhub
        uses: docker/build-push-action@v3
        with:
          push: true
          tags: willy0912/kubify-local:v${{ steps.getversion.outputs.version }}